<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Galeri Sad üòî</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <script type="module" src="supabase.js"></script>
  <style>
    body {
      margin: 0;
      background: url('https://files.catbox.moe/n9hcgz.jpg') no-repeat center center fixed;
      background-size: cover;
      font-family: 'Segoe UI', sans-serif;
    }
    .overlay {
      background: rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(10px);
      min-height: 100vh;
      padding: 2rem 1rem;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .fade-in {
      animation: fadeIn 1s ease-in-out;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
  </style>
</head>
<body>
  <div class="overlay">
    <h1 class="text-3xl text-white font-semibold mb-6 fade-in">üíî Galeri Sad</h1>

    <!-- Form Upload -->
    <div class="bg-gray-900 bg-opacity-60 p-4 rounded-lg shadow-lg max-w-md w-full mb-10 fade-in">
      <textarea id="caption" placeholder="Curhatmu..." rows="3" class="w-full p-2 rounded bg-gray-800 text-white mb-3"></textarea>
      <input type="file" id="fileInput" accept="image/*,video/*" class="text-white mb-3" />
      <button onclick="uploadCurhat()" class="w-full bg-red-500 hover:bg-red-600 text-white py-2 rounded">üåßÔ∏è Upload Curhat</button>
    </div>

    <!-- Galeri Curhat -->
    <div id="galeri" class="w-full max-w-2xl space-y-6 fade-in"></div>
  </div>

  <script type="module">
    import { supabase } from './supabase.js';

    async function uploadCurhat() {
      const caption = document.getElementById('caption').value.trim();
      const fileInput = document.getElementById('fileInput');
      const file = fileInput.files[0];

      if (!caption && !file) {
        alert("Isi caption atau pilih file dulu üò¢");
        return;
      }

      let mediaUrl = null;
      let mediaType = null;

      if (file) {
        const filename = `${Date.now()}_${file.name}`;
        const { data, error } = await supabase.storage
          .from('galerisad')
          .upload(`media/${filename}`, file);

        if (error) {
          alert(`‚ùå Gagal upload media: ${error.message}`);
          return;
        }

        const { data: publicUrl } = supabase
          .storage
          .from('galerisad')
          .getPublicUrl(`media/${filename}`);

        mediaUrl = publicUrl.publicUrl;
        mediaType = file.type.startsWith("image") ? "image" :
                    file.type.startsWith("video") ? "video" : "other";
      }

      const { error: dbError } = await supabase
        .from('galerisad')
        .insert([{ caption, media_url: mediaUrl, media_type: mediaType }]);

      if (dbError) {
        alert(`‚ùå Gagal simpan curhat: ${dbError.message}`);
      } else {
        alert("‚úÖ Curhat berhasil disimpan.");
        location.reload();
      }
    }

    async function fetchCurhat() {
      const galeri = document.getElementById('galeri');
      const { data, error } = await supabase
        .from('galerisad')
        .select('*')
        .order('created_at', { ascending: false });

      if (error) {
        galeri.innerHTML = `<p class="text-red-400">‚ùå Gagal mengambil data: ${error.message}</p>`;
        return;
      }

      if (data.length === 0) {
        galeri.innerHTML = `<p class="text-gray-400 text-center">Belum ada curhatan üòû</p>`;
        return;
      }

      galeri.innerHTML = data.map(post => {
        const waktu = new Date(post.created_at).toLocaleString('id-ID', { timeZone: 'Asia/Jakarta' });
        const captionHtml = post.caption ? `<p class="text-white text-sm mb-2 whitespace-pre-line">${post.caption}</p>` : '';
        const mediaHtml = post.media_type === "image" ? `<img src="${post.media_url}" class="rounded border border-gray-700 w-full"/>`
                         : post.media_type === "video" ? `<video controls class="rounded w-full"><source src="${post.media_url}" type="video/mp4" /></video>`
                         : '';

        return `
          <div class="bg-gray-800 bg-opacity-60 p-4 rounded shadow">
            ${captionHtml}
            ${mediaHtml}
            <p class="text-right text-gray-400 text-xs mt-2">${waktu}</p>
          </div>
        `;
      }).join('');
    }

    fetchCurhat();
    window.uploadCurhat = uploadCurhat;
  </script>
</body>
</html>
